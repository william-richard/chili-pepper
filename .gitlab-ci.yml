image: python:3.7-stretch

services:
  - docker:dind


variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_DRIVER: overlay2
  AWS_DEFAULT_REGION: us-east-1
  AWS_ACCESS_KEY_ID: fake_key
  AWS_SECRET_ACCESS_KEY: fake_secret

before_script:
  - curl -fsSL https://get.docker.com | bash
  - pip install -e .

stages:
  #- test
  - deploy

#lint:
#  image: python:3.7-stretch
#  stage: test
#  services: []
#  before_script: []
#  script:
#    - pip install -r requirements_lint.txt
#    - black --check --diff .
#    - flake8
#
#test:2.7:
#  stage: test
#  script:
#    - pip install -r requirements_test.txt
#    - pytest -vv tests --cov chili_pepper
#
#test:3.6:
#  stage: test
#  script:
#    - pip install -r requirements_test.txt
#    - pytest -vv tests --cov chili_pepper
#
#test:3.7:
#  stage: test
#  script:
#    - pip install -r requirements_test.txt
#    - pytest -vv tests --cov chili_pepper

deploy_staging:
  stage: deploy
  image: python:3.7-stretch
  services: []
  before_script: []
  only:
    - master
    - make-gitlab-deploy-to-pypi
  except:
    - tags
  variables:
    TWINE_USERNAME: $STAGING_USERNAME
    TWINE_PASSWORD: $STAGING_PASSWORD
  script:
    - pip install twine
    - python setup.py sdist bdist_wheel
    - env
    - twine upload --repository-url $TEST_PYPI_REPOSITORY_URL dist/*

deploy_prod:
  stage: deploy
  image: python:3.7-stretch
  services: []
  before_script: []
  only:
    - tags
  variables:
    TWINE_USERNAME: $PRODUCTION_USERNAME
    TWINE_PASSWORD: $PRODUCTION_PASSWORD
  script:
    - pip install twine
    - python setup.py sdist bdist_wheel
    - env
    - twine upload --verbose dist/*
